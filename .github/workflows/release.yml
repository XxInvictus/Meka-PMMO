name: Release Build & Publish

on:
  push:
    branches:
      - '1.20.1-release'
    paths:
      - 'src/**'
      - 'gradle.properties'
      - 'build.gradle'
      - 'CHANGELOG.md'
      - '.github/workflows/release.yml'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - '1.20.1-release'
    paths:
      - 'src/**'
      - 'gradle.properties'
      - 'build.gradle'
      - 'CHANGELOG.md'
      - 'RELEASE_CHANGELOG.md'
      - '.github/workflows/release.yml'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build and test only, skip publishing)'
        required: false
        default: false
        type: boolean
      publish_github:
        description: 'Publish to GitHub Releases'
        required: false
        default: true
        type: boolean
      publish_modrinth:
        description: 'Publish to Modrinth'
        required: false
        default: true
        type: boolean
      publish_curseforge:
        description: 'Publish to CurseForge'
        required: false
        default: true
        type: boolean
      skip_tag:
        description: 'Skip tag creation (use existing tag)'
        required: false
        default: false
        type: boolean
      custom_changelog:
        description: 'Custom changelog (leave empty to use RELEASE_CHANGELOG.md)'
        required: false
        default: ''
        type: string

# Prevent multiple releases at once
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build & Tag Release
    runs-on: ubuntu-latest
    outputs:
      minecraft_version: ${{ steps.properties.outputs.minecraft_version }}
      mod_version: ${{ steps.properties.outputs.mod_version }}
      mod_name: ${{ steps.properties.outputs.mod_name }}
      mod_id: ${{ steps.properties.outputs.mod_id }}
      full_version: ${{ steps.properties.outputs.full_version }}
      changelog: ${{ steps.custom_changelog_check.outputs.using_custom == 'true' && steps.custom_changelog_check.outputs.changelog || steps.changelog.outputs.changelog }}
      dry_run: ${{ steps.check_dry_run.outputs.dry_run }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if Dry Run Mode
        id: check_dry_run
        run: |
          # Check if workflow_dispatch with dry_run input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
            echo "Dry run mode: enabled via workflow input"
            exit 0
          fi
          
          # For push events, check various dry-run conditions
          if [ "${{ github.event_name }}" = "push" ]; then
            # Check if commit message contains [NO-PUBLISH] marker
            commit_message="${{ github.event.head_commit.message }}"
            if echo "$commit_message" | grep -qi "\[NO-PUBLISH\]"; then
              echo "dry_run=true" >> $GITHUB_OUTPUT
              echo "Dry run mode: commit message contains [NO-PUBLISH]"
              echo "Commit message: $commit_message"
              exit 0
            fi
            
            git fetch origin ${{ github.event.before }} || true
            
            # Get list of changed files
            if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            else
              # First commit, check all files
              changed_files=$(git ls-files)
            fi
            
            # Check if only workflow files were changed
            non_workflow_changes=$(echo "$changed_files" | grep -v '^\.github/workflows/' || true)
            
            if [ -z "$non_workflow_changes" ]; then
              echo "dry_run=true" >> $GITHUB_OUTPUT
              echo "Dry run mode: only workflow files changed"
              echo "Changed files:"
              echo "$changed_files"
              exit 0
            fi
          fi
          
          # Not a dry run
          echo "dry_run=false" >> $GITHUB_OUTPUT
          echo "Normal release mode"
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant Execute Permission to Gradlew
        run: chmod +x gradlew
      
      - name: Cache Gradle Build Cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches/build-cache-*
          key: ${{ runner.os }}-gradle-buildcache-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-buildcache-
      
      - name: Extract Properties
        id: properties
        run: |
          # Extract values from gradle.properties
          minecraft_version=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          mod_version=$(grep '^mod_version=' gradle.properties | cut -d'=' -f2)
          mod_name=$(grep '^mod_name=' gradle.properties | cut -d'=' -f2)
          mod_id=$(grep '^mod_id=' gradle.properties | cut -d'=' -f2)
          full_version="${minecraft_version}-${mod_version}"
          
          # Set outputs
          echo "minecraft_version=${minecraft_version}" >> $GITHUB_OUTPUT
          echo "mod_version=${mod_version}" >> $GITHUB_OUTPUT
          echo "mod_name=${mod_name}" >> $GITHUB_OUTPUT
          echo "mod_id=${mod_id}" >> $GITHUB_OUTPUT
          echo "full_version=${full_version}" >> $GITHUB_OUTPUT
          
          # Print for debugging
          echo "Building ${mod_name} v${full_version}"
      
      - name: Check for Version Conflicts
        id: version_check
        continue-on-error: true
        run: |
          tag="${{ steps.properties.outputs.full_version }}"
          
          # Check if tag exists
          if git ls-remote --tags origin | grep -q "refs/tags/${tag}$"; then
            echo "::warning::Tag ${tag} already exists. This is a rebuild of an existing version."
            echo "::warning::Consider using [NO-PUBLISH] in commit message to dry-run test."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version ${tag} is new."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build with Gradle
        run: ./gradlew build --no-daemon --build-cache --parallel
        env:
          GRADLE_BUILD_ACTION_CACHE_KEY_PREFIX: release
      
      - name: Set Custom Changelog
        id: custom_changelog_check
        run: |
          if [ -n "${{ inputs.custom_changelog }}" ]; then
            echo "using_custom=true" >> $GITHUB_OUTPUT
            echo "Custom changelog provided via workflow input"
            echo "${{ inputs.custom_changelog }}" > changelog.txt
            
            # Set output
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            cat changelog.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "using_custom=false" >> $GITHUB_OUTPUT
            echo "Will extract changelog from RELEASE_CHANGELOG.md"
          fi
      
      - name: Extract Changelog
        id: changelog
        if: steps.custom_changelog_check.outputs.using_custom != 'true'
        run: |
          # Extract changelog for current version from RELEASE_CHANGELOG.md
          version="${{ steps.properties.outputs.mod_version }}"
          
          # Extract the changelog section for the current version
          # Format: ## Version X.Y.Z
          # Read from the version header until the next version header or separator line
          changelog=$(awk "/## Version ${version}/,/^## Version [0-9]|^---$/" RELEASE_CHANGELOG.md | sed '1d;$d')
          
          # Trim any trailing whitespace and empty lines
          changelog=$(echo "$changelog" | sed -e :a -e '/^\s*$/d;/^\s*$/{$d;N;ba' -e '}')
          
          # If changelog is empty, use a default message
          if [ -z "$changelog" ] || [ "$changelog" = " " ]; then
            changelog="Release version ${version}"
            echo "Warning: Could not extract changelog for version ${version}"
          else
            echo "Successfully extracted changelog for version ${version}"
          fi
          
          # Write to file to preserve newlines
          echo "$changelog" > changelog.txt
          
          # Set output (GitHub Actions will read from file)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Tag
        if: |
          steps.check_dry_run.outputs.dry_run != 'true' && 
          (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && 
          inputs.skip_tag != true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          tag="${{ steps.properties.outputs.full_version }}"
          
          # Check if tag already exists
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists, skipping tag creation"
          else
            git tag -a "$tag" -m "Release ${{ steps.properties.outputs.mod_name }} $tag"
            git push origin "$tag"
            echo "Created and pushed tag: $tag"
          fi
      
      - name: Generate Source Hash
        id: source_hash
        run: |
          # Generate hash of source files to detect actual code changes
          source_hash=$(find src -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=${source_hash}" >> $GITHUB_OUTPUT
          echo "Source hash: ${source_hash}"
      
      - name: Cache Build Output
        uses: actions/cache/save@v4
        if: always()
        with:
          path: build/libs/*.jar
          key: release-build-${{ steps.properties.outputs.full_version }}-${{ steps.source_hash.outputs.hash }}
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: build/libs/*.jar
          retention-days: 30
          compression-level: 6

  release:
    name: Create GitHub Release
    needs: build
    if: |
      needs.build.result == 'success' && 
      needs.build.outputs.dry_run != 'true' &&
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && inputs.dry_run != true && inputs.publish_github != false))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Restore Build Cache
        uses: actions/cache/restore@v4
        id: cache_restore
        with:
          path: build/libs/*.jar
          key: release-build-${{ needs.build.outputs.full_version }}-
          restore-keys: |
            release-build-${{ needs.build.outputs.full_version }}-
          fail-on-cache-miss: false
      
      - name: Download Build Artifacts (Fallback)
        if: steps.cache_restore.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: build/libs
      
      - name: Check if Release Exists
        id: check_release
        run: |
          tag="${{ needs.build.outputs.full_version }}"
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $tag already exists, will update it"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $tag does not exist, will create it"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build.outputs.full_version }}
          name: ${{ needs.build.outputs.mod_name }} ${{ needs.build.outputs.full_version }}
          body: ${{ needs.build.outputs.changelog }}
          files: build/libs/*.jar
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    name: Publish to Platforms
    needs: [build, release]
    if: |
      needs.build.result == 'success' && 
      needs.build.outputs.dry_run != 'true' &&
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && inputs.dry_run != true && 
        (inputs.publish_modrinth != false || inputs.publish_curseforge != false || inputs.publish_github != false)))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Restore Build Cache
        uses: actions/cache/restore@v4
        id: cache_restore
        with:
          path: build/libs/*.jar
          key: release-build-${{ needs.build.outputs.full_version }}-
          restore-keys: |
            release-build-${{ needs.build.outputs.full_version }}-
          fail-on-cache-miss: false
      
      - name: Download Build Artifacts (Fallback)
        if: steps.cache_restore.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: build/libs
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Publish to GitHub, Modrinth, and CurseForge
        uses: Kir-Antipov/mc-publish@v3.3
        continue-on-error: true
        id: publish
        with:
          # GitHub Release
          github-token: ${{ (github.event_name == 'push' || inputs.publish_github != false) && secrets.GITHUB_TOKEN || '' }}
          github-tag: ${{ needs.build.outputs.full_version }}
          github-generate-changelog: false
          github-draft: false
          github-prerelease: false
          
          # Modrinth
          modrinth-id: ${{ (github.event_name == 'push' || inputs.publish_modrinth != false) && secrets.MODRINTH_PROJECT_ID || '' }}
          modrinth-token: ${{ (github.event_name == 'push' || inputs.publish_modrinth != false) && secrets.MODRINTH_TOKEN || '' }}
          modrinth-featured: true
          
          # CurseForge
          curseforge-id: ${{ (github.event_name == 'push' || inputs.publish_curseforge != false) && secrets.CURSEFORGE_PROJECT_ID || '' }}
          curseforge-token: ${{ (github.event_name == 'push' || inputs.publish_curseforge != false) && secrets.CURSEFORGE_TOKEN || '' }}
          
          # Common settings
          name: ${{ needs.build.outputs.mod_name }} ${{ needs.build.outputs.full_version }}
          version: ${{ needs.build.outputs.full_version }}
          version-type: release
          changelog: ${{ needs.build.outputs.changelog }}
          
          # Loaders and game versions
          loaders: forge
          game-versions: ${{ needs.build.outputs.minecraft_version }}
          
          # Dependencies (new format)
          dependencies: |
            mekanism(required){modrinth:Ce6I4WUE}{curseforge:268560}
            project-mmo(required){modrinth:KFQYC1Uy}{curseforge:353935}
          
          # Files to publish
          files: build/libs/${{ needs.build.outputs.mod_id }}-${{ needs.build.outputs.full_version }}.jar
          
          # Retry settings
          retry-attempts: 2
          retry-delay: 10000
          fail-mode: skip
      
      - name: Check Publish Status
        if: steps.publish.outcome == 'failure'
        run: |
          echo "::warning::Publishing failed, but continuing workflow. Check if version already exists on platforms."

  cleanup:
    name: Cleanup Artifacts
    needs: [build, release, publish]
    if: always() && (needs.publish.result == 'success' || needs.publish.result == 'failure')
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete Build Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: release-artifacts
          failOnError: false
