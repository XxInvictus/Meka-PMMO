name: Dev Build & Test

on:
  push:
    branches:
      - '1.20.1-dev'
    paths:
      - 'src/**'
      - 'gradle.properties'
      - 'build.gradle'
      - 'settings.gradle'
      - '.github/workflows/dev-build.yml'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - '1.20.1-dev'
    paths:
      - 'src/**'
      - 'gradle.properties'
      - 'build.gradle'
      - 'settings.gradle'
      - '.github/workflows/dev-build.yml'
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run tests after build'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      test_type:
        description: 'Which tests to run'
        required: false
        default: 'both'
        type: choice
        options:
          - 'both'
          - 'client'
          - 'server'
          - 'none'

# Cancel in-progress runs when a new one is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Mod
    runs-on: ubuntu-latest
    outputs:
      minecraft_version: ${{ steps.properties.outputs.minecraft_version }}
      mod_version: ${{ steps.properties.outputs.mod_version }}
      mod_name: ${{ steps.properties.outputs.mod_name }}
      mod_id: ${{ steps.properties.outputs.mod_id }}
      forge_version: ${{ steps.properties.outputs.forge_version }}
      mekanism_version: ${{ steps.properties.outputs.mekanism_version }}
      mekanism_subversion: ${{ steps.properties.outputs.mekanism_subversion }}
      pmmo_version: ${{ steps.properties.outputs.pmmo_version }}
      artifact_name: ${{ steps.properties.outputs.artifact_name }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant Execute Permission to Gradlew
        run: chmod +x gradlew
      
      - name: Extract Properties
        id: properties
        run: |
          # Extract values from gradle.properties
          minecraft_version=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          mod_version=$(grep '^mod_version=' gradle.properties | cut -d'=' -f2)
          mod_name=$(grep '^mod_name=' gradle.properties | cut -d'=' -f2)
          mod_id=$(grep '^mod_id=' gradle.properties | cut -d'=' -f2)
          forge_version=$(grep '^forge_version=' gradle.properties | cut -d'=' -f2)
          mekanism_version=$(grep '^mekanism_version=' gradle.properties | cut -d'=' -f2)
          mekanism_subversion=$(grep '^mekanism_subversion=' gradle.properties | cut -d'=' -f2)
          pmmo_version=$(grep '^pmmo_version=' gradle.properties | cut -d'=' -f2)
          
          # Set outputs
          echo "minecraft_version=${minecraft_version}" >> $GITHUB_OUTPUT
          echo "mod_version=${mod_version}" >> $GITHUB_OUTPUT
          echo "mod_name=${mod_name}" >> $GITHUB_OUTPUT
          echo "mod_id=${mod_id}" >> $GITHUB_OUTPUT
          echo "forge_version=${forge_version}" >> $GITHUB_OUTPUT
          echo "mekanism_version=${mekanism_version}" >> $GITHUB_OUTPUT
          echo "mekanism_subversion=${mekanism_subversion}" >> $GITHUB_OUTPUT
          echo "pmmo_version=${pmmo_version}" >> $GITHUB_OUTPUT
          echo "artifact_name=${mod_id}-${minecraft_version}-${mod_version}.jar" >> $GITHUB_OUTPUT
          
          # Print for debugging
          echo "Building ${mod_name} v${minecraft_version}-${mod_version}"
      
      - name: Build with Gradle
        run: ./gradlew build --no-daemon
      
      - name: Download Dependencies
        run: |
          mkdir -p dependencies
          
          # Download Mekanism from ModMaven
          curl -L "https://modmaven.dev/mekanism/Mekanism/${{ steps.properties.outputs.minecraft_version }}-${{ steps.properties.outputs.mekanism_version }}.${{ steps.properties.outputs.mekanism_subversion }}/Mekanism-${{ steps.properties.outputs.minecraft_version }}-${{ steps.properties.outputs.mekanism_version }}.${{ steps.properties.outputs.mekanism_subversion }}.jar" \
            -o "dependencies/Mekanism-${{ steps.properties.outputs.minecraft_version }}-${{ steps.properties.outputs.mekanism_version }}.${{ steps.properties.outputs.mekanism_subversion }}.jar"
          
          # Download PMMO from Modrinth - Query API to get the correct version ID
          echo "Fetching PMMO version info from Modrinth API..."
          PMMO_VERSION_DATA=$(curl -s "https://api.modrinth.com/v2/project/project-mmo/version" | \
            jq -r ".[] | select(.game_versions[] | contains(\"${{ steps.properties.outputs.minecraft_version }}\")) | select(.version_number == \"${{ steps.properties.outputs.minecraft_version }}-${{ steps.properties.outputs.pmmo_version }}\") | .files[0].url" | head -n 1)
          
          if [ -n "$PMMO_VERSION_DATA" ] && [ "$PMMO_VERSION_DATA" != "null" ]; then
            echo "Found PMMO download URL: $PMMO_VERSION_DATA"
            curl -L "$PMMO_VERSION_DATA" \
              -o "dependencies/pmmo-${{ steps.properties.outputs.minecraft_version }}-${{ steps.properties.outputs.pmmo_version }}.jar"
          else
            echo "Warning: Could not find PMMO version ${{ steps.properties.outputs.minecraft_version }}-${{ steps.properties.outputs.pmmo_version }} in Modrinth API"
            exit 1
          fi
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/*.jar
          retention-days: 3
      
      - name: Upload Dependencies
        uses: actions/upload-artifact@v4
        with:
          name: dependencies
          path: dependencies/*.jar
          retention-days: 1
      
      - name: Upload Properties for Next Stages
        uses: actions/upload-artifact@v4
        with:
          name: gradle-properties
          path: gradle.properties
          retention-days: 1

  test-client:
    name: Test Client
    needs: build
    runs-on: ubuntu-latest
    # Skip tests on PR pushes (they run on PR open/update)
    # For workflow_dispatch, respect the inputs
    if: |
      needs.build.result == 'success' && (
        (github.event_name != 'push' || github.ref == 'refs/heads/1.20.1-dev') ||
        (github.event_name == 'workflow_dispatch' && 
         inputs.run_tests == 'true' && 
         (inputs.test_type == 'both' || inputs.test_type == 'client'))
      )
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs
      
      - name: Download Dependencies
        uses: actions/download-artifact@v4
        with:
          name: dependencies
          path: dependencies
      
      - name: Download Gradle Properties
        uses: actions/download-artifact@v4
        with:
          name: gradle-properties
          path: .
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Extract Properties
        id: properties
        run: |
          minecraft_version=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          forge_version=$(grep '^forge_version=' gradle.properties | cut -d'=' -f2)
          
          echo "minecraft_version=${minecraft_version}" >> $GITHUB_OUTPUT
          echo "forge_version=${forge_version}" >> $GITHUB_OUTPUT
      
      - name: Prepare Test Environment
        run: |
          mkdir -p run/mods
          cp build/libs/*.jar run/mods/
          cp dependencies/*.jar run/mods/
      
      - name: Run Client Test
        uses: headlesshq/mc-runtime-test@4.1.0
        with:
          java: '17'
          mc: ${{ steps.properties.outputs.minecraft_version }}
          modloader: forge
          regex: '.*forge.*'
          mc-runtime-test: lexforge

  test-server:
    name: Test Server
    needs: build
    runs-on: ubuntu-latest
    # Skip tests on PR pushes (they run on PR open/update)
    # For workflow_dispatch, respect the inputs
    if: |
      needs.build.result == 'success' && (
        (github.event_name != 'push' || github.ref == 'refs/heads/1.20.1-dev') ||
        (github.event_name == 'workflow_dispatch' && 
         inputs.run_tests == 'true' && 
         (inputs.test_type == 'both' || inputs.test_type == 'server'))
      )
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs
      
      - name: Download Dependencies
        uses: actions/download-artifact@v4
        with:
          name: dependencies
          path: dependencies
      
      - name: Download Gradle Properties
        uses: actions/download-artifact@v4
        with:
          name: gradle-properties
          path: .
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Extract Properties
        id: properties
        run: |
          minecraft_version=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          forge_version=$(grep '^forge_version=' gradle.properties | cut -d'=' -f2)
          
          echo "minecraft_version=${minecraft_version}" >> $GITHUB_OUTPUT
          echo "forge_version=${forge_version}" >> $GITHUB_OUTPUT
      
      - name: Prepare Test Environment
        run: |
          mkdir -p run/mods
          cp build/libs/*.jar run/mods/
          cp dependencies/*.jar run/mods/
      
      - name: Run Server Test
        uses: headlesshq/mc-runtime-test@4.1.0
        with:
          java: '17'
          mc: ${{ steps.properties.outputs.minecraft_version }}
          modloader: forge
          regex: '.*forge.*'
          mc-runtime-test: lexforge

  cleanup:
    name: Cleanup Artifacts
    needs: [build, test-client, test-server]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete Build Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            build-artifacts
            dependencies
            gradle-properties
          failOnError: false
